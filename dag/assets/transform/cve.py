# imports
import ibis
import dagster
import ibis.selectors as s


from dag import functions as f


@dagster.asset
def transform_vulnerabilities_and_categories(extract_vulnerabilities, extract_categories):
    """Transform the cve vulnerabilities data."""
    vulnerabilities = f.clean_data(extract_vulnerabilities)
    vulnerabilities = vulnerabilities.unpack("cve")
    vulnerabilities = vulnerabilities.mutate(
        published=ibis._.published.cast("timestamp"),
        last_modified=ibis._.lastModified.cast("timestamp")
    )
    vulnerabilities = vulnerabilities.mutate(
        primary_score=ibis.case()
            .when(
                ibis._.metrics.cvssMetricV31.filter(lambda x: x["type"]=="Primary").length()==1,
                ibis._.metrics.cvssMetricV31.filter(lambda x: x["type"]=="Primary")[0]["cvssData"]["baseScore"]
            ).when(
                ibis._.metrics.cvssMetricV30.filter(lambda x: x["type"]=="Primary").length()==1,
                ibis._.metrics.cvssMetricV30.filter(lambda x: x["type"]=="Primary")[0]["cvssData"]["baseScore"]
            ).when(
                ibis._.metrics.cvssMetricV40.filter(lambda x: x["type"]=="Primary").length()==1,
                ibis._.metrics.cvssMetricV40.filter(lambda x: x["type"]=="Primary")[0]["cvssData"]["baseScore"]
            ).end()
    )
    vulnerabilities = vulnerabilities.mutate(
        weaknesses_values=ibis._.weaknesses
            .map(lambda x: (x.description))
            .flatten()
            .filter(lambda x: x.lang=="en")
            .map(lambda x: (x.value)))

    vulnerabilities = vulnerabilities.unnest("weaknesses_values", keep_empty=True).distinct(on=["id","weaknesses_values"])
    categories = f.clean_data(extract_categories)
    categories = categories.mutate(category_id='CWE-' + ibis._.cwe_id)

    vuln_categories_joined = vulnerabilities.join(categories, vulnerabilities.weaknesses_values == categories.category_id, how="left")
    vuln_categories_joined = vuln_categories_joined.order_by(ibis._.published.desc())    

    return vuln_categories_joined
