import fnmatch
import os
import ibis
import shutil

import logging as log


def main():
    postprocess()


def postprocess() -> None:
    """
    Postprocess the data.
    """
    log.basicConfig(
        level=log.INFO,
    )

    source_path = "data/system/duckdb/load"
    target_path = "data/data.ddb"
    app_path = "data/app.ddb"

    target = ibis.duckdb.connect(target_path)

    for root, dirs, files in os.walk(source_path):
        for file in files:
            if fnmatch.fnmatch(file, "*.ddb"):
                full_path = os.path.join(root, file)
                con = ibis.duckdb.connect(full_path)
                for table_name in con.tables:
                    log.info(f"Backing up {table_name} (from {full_path}) to {target_path}...")
                    table = con.table(table_name)
                    target_table_name = table_name.replace("load_", "")
                    target.create_table(target_table_name, table.to_pyarrow(), overwrite=True)

    log.info(f"Copying {target_path} to {app_path}...")
    shutil.copy(target_path, app_path)


if __name__ == "__main__":
    main()
