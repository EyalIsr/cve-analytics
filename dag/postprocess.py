import fnmatch
import os
import ibis
import shutil
import toml

import logging as log


def main():
    postprocess()


def postprocess() -> None:
    """
    Postprocess the data.
    """
    log.basicConfig(
        level=log.INFO,
    )

    
    # load config
    config = toml.load("config.toml")["app"]
    log.info(f"Deploying to {config['database']}...")

    # connect to the database
    target = ibis.duckdb.connect(f"{config['database']}")

    source_path = "data/system/duckdb/load"

    for root, dirs, files in os.walk(source_path):
        for file in files:
            if fnmatch.fnmatch(file, "*.ddb"):
                full_path = os.path.join(root, file)
                con = ibis.duckdb.connect(full_path)
                for table_name in con.tables:
                    log.info(f"Backing up {table_name} (from {full_path}) to {config['database']}...")
                    table = con.table(table_name)
                    target_table_name = table_name.replace("load_", "")
                    target.create_table(target_table_name, table.to_pyarrow(), overwrite=True)


if __name__ == "__main__":
    main()
